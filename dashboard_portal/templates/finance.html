{% extends "base.html" %}

{% block title %}Financial Dashboard - Bevco{% endblock %}
{% block page_title %}Financial Dashboard{% endblock %}

{% block content %}
<div class="row">
    <!-- Financial KPI Cards -->
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="dashboard-card kpi-card">
            <div class="kpi-label">Revenue (YTD)</div>
            <div class="kpi-value text-primary" id="ytdRevenue">R 0</div>
            <div class="kpi-change positive">
                <i class="fas fa-arrow-up me-1"></i>+15.3% vs LY
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="dashboard-card kpi-card">
            <div class="kpi-label">Gross Margin</div>
            <div class="kpi-value text-success" id="grossMargin">0%</div>
            <div class="kpi-change negative">
                <i class="fas fa-arrow-down me-1"></i>-1.8% vs Target
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="dashboard-card kpi-card">
            <div class="kpi-label">EBITDA</div>
            <div class="kpi-value text-warning" id="ebitda">R 0</div>
            <div class="kpi-change positive">
                <i class="fas fa-arrow-up me-1"></i>+7.2% vs LY
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="dashboard-card kpi-card">
            <div class="kpi-label">Cash Flow</div>
            <div class="kpi-value text-info" id="cashFlow">R 0</div>
            <div class="kpi-change positive">
                <i class="fas fa-arrow-up me-1"></i>+22.1% vs LY
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Revenue vs Profit Trend -->
    <div class="col-xl-8 col-lg-7 mb-4">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-primary me-2"></i>Revenue vs Profit Trend (12 Months)
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm active">Monthly</button>
                    <button type="button" class="btn btn-outline-primary btn-sm">Quarterly</button>
                    <button type="button" class="btn btn-outline-primary btn-sm">Yearly</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Profit Margin by Category -->
    <div class="col-xl-4 col-lg-5 mb-4">
        <div class="dashboard-card">
            <h5 class="card-title mb-3">
                <i class="fas fa-percentage text-success me-2"></i>Profit Margin by Category
            </h5>
            <div class="chart-container">
                <canvas id="marginChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Budget vs Actual -->
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="dashboard-card">
            <h5 class="card-title mb-3">
                <i class="fas fa-balance-scale text-warning me-2"></i>Budget vs Actual (YTD)
            </h5>
            <div class="chart-container">
                <canvas id="budgetChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Financial Ratios -->
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="dashboard-card">
            <h5 class="card-title mb-3">
                <i class="fas fa-calculator text-info me-2"></i>Key Financial Ratios
            </h5>
            <div class="financial-ratios">
                <div class="ratio-item d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                    <div>
                        <div class="ratio-name fw-bold">Current Ratio</div>
                        <div class="ratio-description text-muted small">Current Assets / Current Liabilities</div>
                    </div>
                    <div class="ratio-value">
                        <span class="h4 text-success mb-0" id="currentRatio">2.3</span>
                        <div class="text-success small">Good</div>
                    </div>
                </div>
                
                <div class="ratio-item d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                    <div>
                        <div class="ratio-name fw-bold">Debt-to-Equity</div>
                        <div class="ratio-description text-muted small">Total Debt / Total Equity</div>
                    </div>
                    <div class="ratio-value">
                        <span class="h4 text-warning mb-0" id="debtEquityRatio">0.65</span>
                        <div class="text-warning small">Moderate</div>
                    </div>
                </div>
                
                <div class="ratio-item d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                    <div>
                        <div class="ratio-name fw-bold">ROE</div>
                        <div class="ratio-description text-muted small">Return on Equity</div>
                    </div>
                    <div class="ratio-value">
                        <span class="h4 text-primary mb-0" id="roe">18.5%</span>
                        <div class="text-primary small">Excellent</div>
                    </div>
                </div>
                
                <div class="ratio-item d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                    <div>
                        <div class="ratio-name fw-bold">Working Capital</div>
                        <div class="ratio-description text-muted small">Current Assets - Current Liabilities</div>
                    </div>
                    <div class="ratio-value">
                        <span class="h4 text-info mb-0" id="workingCapital">R 8.2M</span>
                        <div class="text-info small">Strong</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Cash Flow Statement -->
    <div class="col-xl-8 col-lg-8 mb-4">
        <div class="dashboard-card">
            <h5 class="card-title mb-3">
                <i class="fas fa-money-bill-wave text-success me-2"></i>Cash Flow Analysis
            </h5>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Cash Flow Component</th>
                            <th>Current Month</th>
                            <th>Previous Month</th>
                            <th>Change</th>
                            <th>YTD</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Operating Cash Flow</strong></td>
                            <td class="text-success">R 2,450,000</td>
                            <td>R 2,180,000</td>
                            <td class="text-success">+12.4%</td>
                            <td class="text-success">R 18,200,000</td>
                        </tr>
                        <tr>
                            <td><strong>Investing Cash Flow</strong></td>
                            <td class="text-danger">-R 850,000</td>
                            <td>-R 920,000</td>
                            <td class="text-success">+7.6%</td>
                            <td class="text-danger">-R 6,800,000</td>
                        </tr>
                        <tr>
                            <td><strong>Financing Cash Flow</strong></td>
                            <td class="text-danger">-R 320,000</td>
                            <td>-R 280,000</td>
                            <td class="text-danger">-14.3%</td>
                            <td class="text-danger">-R 2,900,000</td>
                        </tr>
                        <tr class="table-primary">
                            <td><strong>Net Cash Flow</strong></td>
                            <td class="text-primary fw-bold">R 1,280,000</td>
                            <td>R 980,000</td>
                            <td class="text-success fw-bold">+30.6%</td>
                            <td class="text-primary fw-bold">R 8,500,000</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Financial Alerts -->
    <div class="col-xl-4 col-lg-4 mb-4">
        <div class="dashboard-card">
            <h5 class="card-title mb-3">
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>Financial Alerts
            </h5>
            <div class="alerts-container">
                <div class="alert alert-warning d-flex align-items-center mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <div>
                        <strong>Budget Variance</strong><br>
                        <small>Marketing spend 15% over budget</small>
                    </div>
                </div>
                
                <div class="alert alert-info d-flex align-items-center mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <div>
                        <strong>Payment Due</strong><br>
                        <small>R 2.3M supplier payment due in 3 days</small>
                    </div>
                </div>
                
                <div class="alert alert-success d-flex align-items-center mb-3">
                    <i class="fas fa-check-circle me-2"></i>
                    <div>
                        <strong>Target Achieved</strong><br>
                        <small>Q3 revenue target exceeded by 8%</small>
                    </div>
                </div>
                
                <div class="alert alert-danger d-flex align-items-center mb-3">
                    <i class="fas fa-times-circle me-2"></i>
                    <div>
                        <strong>Credit Limit</strong><br>
                        <small>Customer ABC Ltd approaching credit limit</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let revenueChart, marginChart, budgetChart;

    document.addEventListener('DOMContentLoaded', function() {
        loadFinancialData();
    });

    function loadFinancialData() {
        fetch('/api/financial_data')
            .then(response => response.json())
            .then(data => {
                updateFinancialKPIs(data);
                createFinancialCharts(data);
            })
            .catch(error => {
                console.error('Error loading financial data:', error);
                showAlert('Error loading financial data', 'error');
            });
    }

    function updateFinancialKPIs(data) {
        // Calculate YTD revenue from monthly data
        const ytdRevenue = data.monthly_summary.reduce((sum, month) => sum + month.revenue, 0);
        const ytdProfit = data.monthly_summary.reduce((sum, month) => sum + month.profit, 0);
        const grossMargin = (ytdProfit / ytdRevenue * 100);
        const ebitda = ytdProfit * 1.3; // Mock EBITDA calculation
        const cashFlow = ytdRevenue * 0.15; // Mock cash flow
        
        document.getElementById('ytdRevenue').textContent = formatCurrency(ytdRevenue);
        document.getElementById('grossMargin').textContent = formatPercentage(grossMargin);
        document.getElementById('ebitda').textContent = formatCurrency(ebitda);
        document.getElementById('cashFlow').textContent = formatCurrency(cashFlow);
    }

    function createFinancialCharts(data) {
        // Revenue vs Profit Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        if (revenueChart) revenueChart.destroy();
        
        revenueChart = createChart(revenueCtx, 'line', {
            labels: data.monthly_summary.map(item => {
                const date = new Date(item.month + '-01');
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }),
            datasets: [{
                label: 'Revenue (R)',
                data: data.monthly_summary.map(item => item.revenue),
                borderColor: '#007AFF',
                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                yAxisID: 'y'
            }, {
                label: 'Profit (R)',
                data: data.monthly_summary.map(item => item.profit),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                yAxisID: 'y'
            }]
        }, {
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R' + (value / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            }
        });

        // Profit Margin by Category Chart
        const marginCtx = document.getElementById('marginChart').getContext('2d');
        if (marginChart) marginChart.destroy();
        
        marginChart = createChart(marginCtx, 'bar', {
            labels: data.margin_by_category.map(item => item.product_category),
            datasets: [{
                label: 'Margin %',
                data: data.margin_by_category.map(item => item.margin_percent),
                backgroundColor: [
                    '#FF6B35',
                    '#007AFF', 
                    '#28a745',
                    '#ffc107',
                    '#dc3545'
                ],
                borderRadius: 8
            }]
        }, {
            scales: {
                y: {
                    beginAtZero: true,
                    max: 50,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        });

        // Budget vs Actual Chart
        const budgetCtx = document.getElementById('budgetChart').getContext('2d');
        if (budgetChart) budgetChart.destroy();
        
        // Mock budget data
        const departments = ['Sales', 'Marketing', 'Operations', 'Finance', 'HR', 'IT'];
        const budgetData = departments.map(() => Math.random() * 2000000 + 1000000);
        const actualData = budgetData.map(budget => budget * (0.85 + Math.random() * 0.3));
        
        budgetChart = createChart(budgetCtx, 'bar', {
            labels: departments,
            datasets: [{
                label: 'Budget',
                data: budgetData,
                backgroundColor: 'rgba(0, 122, 255, 0.6)',
                borderColor: '#007AFF',
                borderWidth: 1
            }, {
                label: 'Actual',
                data: actualData,
                backgroundColor: 'rgba(255, 107, 53, 0.6)',
                borderColor: '#FF6B35',
                borderWidth: 1
            }]
        }, {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R' + (value / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            }
        });
    }
</script>

<style>
    .ratio-item {
        transition: all 0.3s ease;
    }

    .ratio-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .alerts-container .alert {
        border: none;
        border-radius: 10px;
        padding: 15px;
    }

    .table-primary {
        background-color: rgba(0, 122, 255, 0.1);
    }

    .financial-ratios {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}